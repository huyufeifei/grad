# 测试

通常认为使用底层的C语言的一个优势是其效率更高。而Rust的零成本抽象为其带来了与C/C++类似的性能。通过对有较高性能需求的块设备驱动的速度测试，可以展现出使用安全代码编写的设备驱动与不安全代码相比性能变化如何。

以下的测试所处环境是：
中央处理器：13th Gen Intel(R) Core(TM) i9-13900HX
操作系统：Windows Subsystem for Linux (WSL) 2 Ubuntu 20.04
虚拟机软件：qemu 7.0.0

## 4.1 块设备

### 4.1.1 吞吐率

对块设备的测试采用顺序读写的方式进行。使用的设备大小为20MB，分别使用本项目的安全Rust实现的驱动和用于对比的使用了不安全代码的设备驱动对其进行总共200次全盘读写，并记录每次的时间和速度。最后以此计算出两种不同驱动的平均速度和方差。

测试所得的原始数据可以在此查看，测试所用代码分别在github代码仓库下的`svdrivers/qemu`和`virtio-drivers/example/riscv`文件夹中。测试的结果如下图：

|操作类型|安全代码|不安全代码|
|-------|-------|--------|
|读     |19.86MB/s 0.0274|19.87MB/s 0.086|
|写     |18.035MB/s 0.129|17.401MB/s 0.038|

从如上数据中可以看出，使用安全代码实现的VirtIO块设备驱动相比于不安全的设备驱动，在顺序读取操作上速度相差无几，而在顺序写入时，其速度甚至比不安全的实现快了3.6%。

写操作普遍比读操作缓慢，但是差距并不大，只有约2MB/s的差距。读和写操作都接近一个上限，即20MB/s。我们认为这个速度是在虚拟环境中使用单处理器对块设备进行读写的速度上限。安全驱动和不安全驱动均接近这个上限，表明在现有应用场景中驱动的性能并没有成为操作的瓶颈。

这些数据说明了在块设备驱动这方面，使用不安全代码并没有显著的速度优势。因此可以放心的使用安全的设备驱动，而不需要担心其可能对性能造成的影响。
